<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Models - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container mt-4">
        <h2>Machine Learning Models Management</h2>
        
        <div th:if="${activeModel}" class="alert alert-success">
            <h5>Active Model: <span th:text="${activeModel.modelName}"></span></h5>
            <p>Algorithm: <span th:text="${activeModel.algorithm}"></span> | 
               Accuracy: <span th:text="${#numbers.formatDecimal(activeModel.accuracy * 100, 1, 2)}">%</span>% | 
               Trained: <span th:text="${#dates.format(activeModel.trainedDate, 'dd/MM/yyyy HH:mm')}"></span>
            </p>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>All Models</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Model Name</th>
                            <th>Algorithm</th>
                            <th>Accuracy</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>Trained Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="modelsBody">
                    <div th:if="${models != null and !models.empty}">
                        <tr th:each="model : ${models}">
                            <td th:text="${model.modelName}"></td>
                            <td th:text="${model.algorithm}"></td>
                            <td th:text="${model.accuracy != null
                                ? #numbers.formatDecimal(model.accuracy * 100, 1, 2) + '%'
                            : '-'}"></td>
                            <td th:text="${model.modelPrecision}"></td>
                            <td th:text="${model.recall}"></td>
                            <td th:text="${model.trainedDate != null ? #dates.format(model.trainedDate, 'dd/MM/yyyy') : '-' }"></td>
                            <td>
                                <span th:if="${model.isActive}" class="badge bg-success">Active</span>
                                <span th:unless="${model.isActive}" class="badge bg-secondary">Inactive</span>
                            </td>
                            <td>
                                <form th:action="@{/admin/models/activate/{id}(id=${model.id})}"
                                      method="post"
                                      th:unless="${model.isActive}"
                                      style="display:inline">

                                    <button type="submit"
                                            class="btn btn-sm btn-outline-success">
                                        Activate
                                    </button>
                                </form>
                            </td>
                        </tr>
                    </div>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="/admin/retrain" class="btn btn-primary">Train New Model</a>
            <a href="/admin/dashboard" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>

<script>
    setInterval(() => {
        fetch('/admin/models/status')
            .then(res => res.json())
            .then(data => updateTable(data));
    }, 5000);

    function updateTable(models) {
        const tbody = document.getElementById("modelsBody");
        tbody.innerHTML = "";

        models.forEach(model => {
            let statusBadge = '';

            if (model.trainingStatus === 'RUNNING') {
                statusBadge = '<span class="badge bg-warning">Training</span>';
            } else if (model.trainingStatus === 'FAILED') {
                statusBadge = '<span class="badge bg-danger">Failed</span>';
            } else if (model.isActive) {
                statusBadge = '<span class="badge bg-success">Active</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">Inactive</span>';
            }

            const row = `
                <tr>
                    <td>${model.modelName}</td>
                    <td>${model.algorithm}</td>
                    <td>${model.accuracy ? (model.accuracy * 100).toFixed(2) + '%' : '-'}</td>
                    <td>${model.modelPrecision ?? '-'}</td>
                    <td>${model.recall ?? '-'}</td>
                    <td>${model.trainedDate ? new Date(model.trainedDate).toLocaleDateString() : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                    ${
                !model.isActive && model.trainingStatus === 'COMPLETED'
                    ? `
                        <form method="post" action="/admin/models/activate/${model.id}" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline-success">
                                Activate
                            </button>
                        </form>
                        `
                    : ''
            }
                </td>
                </tr>
            `;

            tbody.insertAdjacentHTML('beforeend', row);
        });
    }
</script>
</body>
</html>