<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .progress-small {
            height: 20px;
        }
        .risk-high {
            border-left: 4px solid #dc3545;
        }
        .risk-medium {
            border-left: 4px solid #ffc107;
        }
        .risk-low {
            border-left: 4px solid #198754;
        }
        .course-card {
            transition: transform 0.2s;
        }
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-user-graduate"></i> Student Dashboard</h2>
            <p class="text-muted">
                Welcome, <span sec:authentication="name" class="text-primary"></span>!
                <span th:if="${student}" th:text="'Student ID: ' + ${student.studentId}" class="badge bg-secondary ms-2"></span>
                Role: <span class="badge bg-primary" sec:authentication="principal.authorities"></span>
            </p>
        </div>
    </div>

    <!-- Messages -->
    <div th:replace="~{fragments/messages :: messages}"></div>

    <!-- Quick Stats -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-book fa-2x mb-2"></i>
                    <h5 class="card-title">Current Courses</h5>
                    <h2 th:text="${currentCoursesCount ?: 0}">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h5 class="card-title">Avg Pass Chance</h5>
                    <h2 th:text="${averagePassProbability != null ? (#numbers.formatDecimal(averagePassProbability * 100, 1, 1) + '%') : 'N/A'}">78%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h5 class="card-title">At Risk Courses</h5>
                    <h2 th:text="${atRiskCoursesCount ?: 0}">0</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Course Prediction</h5>
                </div>
                <div class="card-body">
                    <p>Get AI-powered prediction for your current courses based on your academic performance.</p>
                    <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#predictModal">
                        <i class="fas fa-play-circle"></i> Predict All Courses
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Performance History</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <p>View your course prediction history</p>
                    <button
                            class="btn btn-success w-100 mt-auto"
                            th:onclick="|window.location.href='@{/student/{id}/prediction-results(id=${student.id})}'|">
                        <i class="fas fa-play-circle"></i> View Prediction History
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Recommendations</h5>
                </div>
                <div class="card-body">
                    <p>Get personalized recommendations to improve your academic performance in specific courses.</p>
                    <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#tipsModal">
                        <i class="fas fa-tips"></i> View Tips
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Courses Predictions -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-book-open"></i> Current Courses Performance</h5>
            <span class="badge bg-light text-dark" th:text="${academicYear} + ' - ' + ${semester}"></span>
        </div>
        <div class="card-body">
            <div th:if="${currentCourses != null and !currentCourses.empty}">
                <div class="row">
                    <div th:each="course : ${currentCourses}" class="col-md-6 mb-3">
                        <div class="card h-100 course-card"
                             th:classappend="${course.attendanceRate} == null ? 'risk-low'
                     : (${course.attendanceRate} < 30 ? 'risk-high'
                     : (${course.attendanceRate} < 70 ? 'risk-medium' : 'risk-low'))">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="card-title mb-1" th:text="${course.course.courseCode}"></h5>
                                        <p class="text-muted small mb-0">
                                            <i class="fas fa-university"></i>
                                            <span th:text="${course.course.department}"></span> |
                                            <i class="fas fa-credit-card"></i>
                                            <span th:text="${course.course.credits}">3</span> Credits
                                        </p>
                                    </div>
                                </div>

                                <!-- Performance Metrics -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Attendance</small>
                                        <div class="progress progress-small">
                                            <div class="progress-bar"
                                                 th:style="'width:' + ${course.attendanceRate} + '%'"
                                                 th:text="${course.attendanceRate} + '%'"></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Assignments</small>
                                        <div class="progress progress-small">
                                            <div class="progress-bar bg-info"
                                                 th:style="'width:' + ${course.assignmentScoresAvg} + '%'"
                                                 th:text="${course.assignmentScoresAvg} + '%'"></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Study Hours</small>
                                        <p class="mb-0" th:text="${course.studyHoursWeekly} + ' hrs/week'"></p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${currentCourses == null or currentCourses.empty}" class="text-center py-5">
                <i class="fas fa-book fa-3x text-muted mb-3"></i>
                <h5>No Current Courses</h5>
                <p class="text-muted">You are not enrolled in any courses for this semester.</p>
                <a th:href="@{/student/enroll}" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Enroll in Courses
                </a>
            </div>
        </div>
    </div>

    <!-- Academic Summary -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Performance Summary</h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye"></i> Areas for Improvement</h5>
                </div>
                <div class="card-body">
                    <div th:if="${improvementAreas != null and !improvementAreas.empty}">
                        <ul class="list-group list-group-flush">
                            <li th:each="area : ${improvementAreas}" class="list-group-item d-flex justify-content-between align-items-center">
                                <span th:text="${area}">Increase attendance in PHYS101</span>
                                <span class="badge bg-warning rounded-pill">High Priority</span>
                            </li>
                        </ul>
                    </div>
                    <div th:if="${improvementAreas == null or improvementAreas.empty}" class="text-center py-4">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">All metrics are within target ranges. Keep up the good work!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Predict Modal -->
<div class="modal fade" id="predictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-chart-line"></i> Course Predictions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Generate predictions for all your current courses. This will analyze your performance data and provide pass/fail probabilities.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Predictions are based on:
                    <ul class="mb-0 mt-2">
                        <li>Current course performance</li>
                        <li>Historical academic data</li>
                        <li>Student background factors</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" th:onclick="'predictAllCourses(' + ${student.id} + ')'">
                    <i class="fas fa-play-circle"></i> Generate Predictions
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tips Modal -->
<div class="modal fade" id="tipsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-lightbulb"></i> Personalized Recommendations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div th:if="${recommendations != null and !recommendations.empty}">
                    <div th:each="rec : ${recommendations}">
                        <div class="card mb-3">
                            <div class="card-header" th:classappend="${rec.priority == 'HIGH'} ? 'bg-danger text-white' :
                                                                      ${rec.priority == 'MEDIUM'} ? 'bg-warning text-dark' : 'bg-info text-white'">
                                <h6 class="mb-0">
                                    <span th:text="${rec.courseCode}">CS101</span>:
                                    <span th:text="${rec.title}">Improve Attendance</span>
                                    <span class="badge" th:classappend="${rec.priority == 'HIGH'} ? 'bg-light text-danger' :
                                                                          ${rec.priority == 'MEDIUM'} ? 'bg-dark' : 'bg-light text-info'"
                                          th:text="${rec.priority}">HIGH</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p th:text="${rec.description}">Your attendance is currently at 65%. Aim for at least 85% to improve your chances of passing.</p>
                                <div class="mt-2">
                                    <strong>Action Items:</strong>
                                    <ul class="mb-0">
                                        <li th:each="action : ${rec.actions}" th:text="${action}">Attend all lectures this week</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${recommendations == null or recommendations.empty}">
                    <h6>General Academic Success Tips:</h6>
                    <ul>
                        <li><strong>Improve Attendance:</strong> Aim for at least 85% attendance in all courses</li>
                        <li><strong>Study Schedule:</strong> Allocate 15-20 hours per week for studying</li>
                        <li><strong>Assignment Focus:</strong> Submit all assignments on time with quality work</li>
                        <li><strong>Ask for Help:</strong> Don't hesitate to ask faculty or TAs for help</li>
                        <li><strong>Time Management:</strong> Create a weekly study plan and stick to it</li>
                        <li><strong>Active Participation:</strong> Engage in class discussions and group work</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Initialize performance chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Attendance', 'Assignments', 'Midterms', 'Participation', 'Study Hours'],
                datasets: [{
                    label: 'Your Performance',
                    data: [85, 78, 75, 80, 70],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }, {
                    label: 'Target',
                    data: [85, 80, 75, 75, 75],
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    });

    // Course prediction functions
    function predictCourse(courseId) {
        fetch('/student/predict-course/' + courseId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Prediction failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating prediction');
            });
    }

    function predictAllCourses(studentId) {
        document.getElementById('predictModal').querySelector('.btn-close').click();

        fetch('/student/' + studentId + '/predict-all-courses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Redirect to results page
                    window.location.href = "/student/" + studentId + "/prediction-results";

                } else {
                    alert("Prediction failed: " + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("An error occurred");
            });
    }

</script>
</body>
</html>